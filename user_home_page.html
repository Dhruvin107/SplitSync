<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SplitSync - Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./CSS/user_home_page.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
    integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
  <div class="container-fluid">
    <div class="row">

      <aside id="sidebar" class="col-md-3 col-lg-2 sidebar">
        <button class="btn btn-sm btn-outline-danger d-md-none mb-3 ms-2" id="closeSidebar">✖</button>

        <h4 class="text-center mb-4 fw-bold">SplitSync</h4>
        <a href="#">Dashboard</a>
        <a href="./user_create_team_page.html">Create / Join Team</a>
        <a href="./user_team_details.html">Team Details</a>
        <a href="./add_expense_page.html">Add Expense</a>
        <a href="./user_expense_list_page.html">Expense List</a>
        <a href="#" id="logoutBtn">Logout</a>
      </aside>

      <main class="col-md-9 col-lg-10 content">

        <button class="btn btn-outline-primary d-md-none mb-3" id="toggleSidebar">
          <i class="fa-solid fa-bars"></i> Menu
        </button>

        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="fw-bold">Trip / Team Name</h3>
          <div class="d-flex align-items-center">
            <span class="fw-semibold" id="userName">User Name</span>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card-metric">
              <h4>Total Expenses</h4>
              <p id="total-expenses">Not Available</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card-metric">
              <h4>My Expenses</h4>
              <p id="my-expenses">Not Available</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card-metric">
              <h4>Total Members</h4>
              <p id="total-members">Not Available</p>
            </div>
          </div>
        </div>

        <div class="card shadow-sm p-3">
          <h5 class="mb-3">Expense Contribution</h5>
          <canvas id="expenseChart" style="max-width: 500px; height: 250px; margin: auto;"></canvas>
        </div>

      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="./JS/user_home_page.js"></script>
  <script src="./JS/config.js"></script>

  <!-- Add a loader overlay inside <body> -->
  <div id="loaderOverlay"
    style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,10);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDdRLOQgTvlsh18PYAgrlS48TA2r_CvXS8",
      authDomain: "splitsync-e5675.firebaseapp.com",
      databaseURL: "https://splitsync-e5675-default-rtdb.firebaseio.com",
      projectId: "splitsync-e5675",
      storageBucket: "splitsync-e5675.firebasestorage.app",
      messagingSenderId: "882841710347",
      appId: "1:882841710347:web:4b9e381450956c92a03c0e",
      measurementId: "G-VJ2PQ1ZV1N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM Elements
    const loaderOverlay = document.getElementById("loaderOverlay");
    const mainContent = document.querySelector("main");
    const userNameSpan = document.getElementById("userName");
    const totalExpensesEl = document.getElementById("total-expenses");
    const myExpensesEl = document.getElementById("my-expenses");
    const totalMembersEl = document.getElementById("total-members");
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const teamNameEl = document.querySelector("h3.fw-bold");

    // Loader helpers
    const showLoader = () => loaderOverlay && (loaderOverlay.style.display = "flex");
    const hideLoader = () => loaderOverlay && (loaderOverlay.style.display = "none");

    // Chart.js setup
    const expenseChart = new Chart(ctx, {
      type: 'pie',
      data: { labels: [], datasets: [{ label: 'Expenses (₹)', data: [], backgroundColor: [], borderWidth: 1 }] },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    // Generate random pastel color
    function randomColor() {
      const r = Math.floor(150 + Math.random() * 100);
      const g = Math.floor(150 + Math.random() * 100);
      const b = Math.floor(150 + Math.random() * 100);
      return `rgb(${r},${g},${b})`;
    }

    // Get user's team code
    async function getUserTeamCode(uid) {
      const snapshot = await get(child(ref(db), "User_Registration/" + uid));
      if (snapshot.exists() && snapshot.val().TeamCode) return snapshot.val().TeamCode;

      const teamsSnap = await get(ref(db, "Team_Details"));
      if (!teamsSnap.exists()) return null;

      for (const [code, team] of Object.entries(teamsSnap.val())) {
        if (team.Members && team.Members[uid]) return code;
      }
      return null;
    }

    // Fetch team expenses and update chart (matching AddedBy with Name)
    async function renderExpenseChart(uid, teamCode) {
      const teamSnap = await get(ref(db, `Team_Details/${teamCode}`));
      if (!teamSnap.exists()) return;

      const team = teamSnap.val();
      const expenses = Object.values(team.Expenses || {});
      const members = team.Members || {};

      // Map UID → Name
      const memberNames = {};
      for (const [id, info] of Object.entries(members)) {
        memberNames[id] = info.Name || info.Email || "Unknown";
      }

      // Get current user Name
      const currentUserSnapshot = await get(child(ref(db), `User_Registration/${uid}`));
      const currentUserName = currentUserSnapshot.exists() ? currentUserSnapshot.val().Name : "User";

      // Sum expenses per member
      const totalsPaid = {};
      let totalExpenses = 0;
      let myExpenses = 0;

      expenses.forEach(exp => {
        const payerName = exp.AddedBy || "Unknown"; // Match by Name
        const amount = Number(exp.Amount || 0);

        totalsPaid[payerName] = (totalsPaid[payerName] || 0) + amount;
        totalExpenses += amount;

        if (payerName === currentUserName) myExpenses += amount;
      });

      // Update metrics
      totalExpensesEl.textContent = totalExpenses.toFixed(2);
      myExpensesEl.textContent = myExpenses.toFixed(2);
      totalMembersEl.textContent = Object.keys(members).length;

      // Update chart
      const memberList = Object.keys(totalsPaid);
      if (memberList.length === 0) {
        expenseChart.data.labels = ["No Expenses"];
        expenseChart.data.datasets[0].data = [1];
        expenseChart.data.datasets[0].backgroundColor = ["#cccccc"];
      } else {
        expenseChart.data.labels = memberList;
        expenseChart.data.datasets[0].data = Object.values(totalsPaid);
        expenseChart.data.datasets[0].backgroundColor = memberList.map(() => randomColor());
      }
      expenseChart.update();
    }

    // Main auth check
    showLoader();
    mainContent.classList.add("d-none");

    onAuthStateChanged(auth, async user => {
      if (!user) { window.location.href = "index.html"; return; }
      const uid = user.uid;

      try {
        // Set username
        const snapshot = await get(child(ref(db), "User_Registration/" + uid));
        userNameSpan.textContent = snapshot.exists() ? snapshot.val().Name || "User" : "User";

        // Get team code
        const teamCode = await getUserTeamCode(uid);
        if (!teamCode) {
          alert("⚠️ You are not in any team.");
          window.location.href = "user_create_team_page.html";
          return;
        }

        // Fetch and display team/trip name
        const teamSnap = await get(ref(db, `Team_Details/${teamCode}`));
        if (teamSnap.exists()) {
          const team = teamSnap.val();
          teamNameEl.textContent = team.TeamName || "Trip / Team Name";
        }

        // Render chart and metrics
        await renderExpenseChart(uid, teamCode);
      } catch (err) {
        console.error("Error loading data:", err);
      } finally {
        hideLoader();
        mainContent.classList.remove("d-none");
      }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async e => {
      e.preventDefault();
      try { await signOut(auth); window.location.href = "index.html"; }
      catch (err) { console.error("Logout error:", err); }
    });

    // Sidebar toggle
    const toggleBtn = document.getElementById("toggleSidebar");
    const closeBtn = document.getElementById("closeSidebar");
    const sidebar = document.getElementById("sidebar");
    toggleBtn.addEventListener("click", () => sidebar.classList.add("active"));
    closeBtn.addEventListener("click", () => sidebar.classList.remove("active"));
  </script>



</body>

</html>