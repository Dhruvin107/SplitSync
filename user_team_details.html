<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SplitSync - Team Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./CSS/user_team_details.css">
    <style>
        /* Loader Overlay */
        #loaderOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 10);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Loader Overlay -->
    <div id="loaderOverlay">
        <div class="loader"></div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <aside id="sidebar" class="col-md-3 col-lg-2 sidebar">
                <button class="btn btn-sm btn-outline-danger d-md-none mb-3 ms-2" id="closeSidebar">✖</button>
                <h4 class="text-center mb-4 fw-bold">SplitSync</h4>
                <a href="./user_home_page.html">Dashboard</a>
                <a href="./user_create_team_page.html">Create / Join Team</a>
                <a href="#">Team Details</a>
                <a href="./add_expense_page.html">Add Expense</a>
                <a href="./user_expense_list_page.html">Expense List</a>
                <a href="#" id="logoutBtn">Logout</a>
            </aside>

            <!-- Main Content -->
            <main class="col-md-9 col-lg-10 content">
                <button class="btn btn-primary mb-3 d-md-none" id="toggleSidebar">☰</button>
                <h3 class="fw-bold">Trip / Team Name</h3>
                <p><strong>Team Code:</strong> <span id="teamCodeDisplay">N/A</span></p>

                <div class="mb-3">
                    <button class="btn btn-danger" id="leaveTeamBtn">Leave Team</button>
                    <button class="btn btn-warning" id="deleteTeamBtn">Delete Team</button>
                </div>

                <h5>Team Members</h5>
                <table class="table table-striped" id="teamMembersTable">
                    <thead>
                        <tr>
                            <th>Sr.No</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, get, child, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdRLOQgTvlsh18PYAgrlS48TA2r_CvXS8",
            authDomain: "splitsync-e5675.firebaseapp.com",
            databaseURL: "https://splitsync-e5675-default-rtdb.firebaseio.com",
            projectId: "splitsync-e5675",
            storageBucket: "splitsync-e5675.firebasestorage.app",
            messagingSenderId: "882841710347",
            appId: "1:882841710347:web:4b9e381450956c92a03c0e",
            measurementId: "G-VJ2PQ1ZV1N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const loaderOverlay = document.getElementById("loaderOverlay");
        const teamNameEl = document.querySelector("h3.fw-bold");
        const teamCodeEl = document.getElementById("teamCodeDisplay");
        const membersTableBody = document.querySelector("#teamMembersTable tbody");
        const leaveTeamBtn = document.getElementById("leaveTeamBtn");
        const deleteTeamBtn = document.getElementById("deleteTeamBtn");

        const toggleBtn = document.getElementById("toggleSidebar");
        const closeBtn = document.getElementById("closeSidebar");
        const sidebar = document.getElementById("sidebar");
        toggleBtn.addEventListener("click", () => sidebar.classList.add("active"));
        closeBtn.addEventListener("click", () => sidebar.classList.remove("active"));

        const showLoader = () => loaderOverlay.style.display = "flex";
        const hideLoader = () => loaderOverlay.style.display = "none";

        // Get user's team code
        async function getUserTeamCode(uid) {
            const snapshot = await get(child(ref(db), "User_Registration/" + uid));
            if (snapshot.exists() && snapshot.val().TeamCode) return snapshot.val().TeamCode;
            const teamsSnap = await get(ref(db, "Team_Details"));
            if (!teamsSnap.exists()) return null;
            for (const [code, team] of Object.entries(teamsSnap.val())) {
                if (team.Members && team.Members[uid]) return code;
            }
            return null;
        }

        // Delete all expenses of a member
        async function deleteMemberExpenses(memberUid, teamCode) {
            const expensesSnap = await get(ref(db, `Team_Details/${teamCode}/Expenses`));
            if (!expensesSnap.exists()) return;
            const expenses = expensesSnap.val();
            for (const [expId, exp] of Object.entries(expenses)) {
                if (exp.AddedByUid === memberUid) {
                    await remove(ref(db, `Team_Details/${teamCode}/Expenses/${expId}`));
                }
            }
        }

        // Render team info
        async function renderTeamInfo(uid) {
            showLoader();
            try {
                const teamCode = await getUserTeamCode(uid);
                if (!teamCode) {
                    alert("You are not in any team!");
                    window.location.href = "./user_create_team_page.html";
                    return;
                }

                teamCodeEl.textContent = teamCode;

                const teamSnap = await get(ref(db, `Team_Details/${teamCode}`));
                if (!teamSnap.exists()) return;
                const team = teamSnap.val();
                teamNameEl.textContent = team.TeamName || "Trip / Team Name";

                membersTableBody.innerHTML = "";

                let count = 1;
                for (const memberUid of Object.keys(team.Members || {})) {
                    const userSnap = await get(ref(db, `User_Registration/${memberUid}`));
                    const memberInfo = userSnap.exists() ? userSnap.val() : { Name: "Unknown", Email: "-" };

                    const row = document.createElement("tr");
                    row.innerHTML = `
        <td>${count}</td>
        <td>${memberInfo.Name}</td>
        <td>${memberInfo.Email}</td>
        <td>
          ${memberUid === uid ?
                            `<button class="btn btn-danger btn-sm leaveBtn">Leave</button>` :
                            `<button class="btn btn-warning btn-sm removeBtn">Remove</button>`}
        </td>
      `;
                    membersTableBody.appendChild(row);

                    const leaveBtn = row.querySelector(".leaveBtn");
                    const removeBtn = row.querySelector(".removeBtn");

                    if (leaveBtn) leaveBtn.addEventListener("click", () => leaveTeam(uid, teamCode));
                    if (removeBtn) removeBtn.addEventListener("click", () => removeMember(memberUid, teamCode));
                    count++;
                }

                if (team.CreatorUid !== uid) deleteTeamBtn.style.display = "none";
                else deleteTeamBtn.style.display = "inline-block";

            } catch (err) {
                console.error(err);
                alert("Error fetching team data.");
            } finally {
                hideLoader();
            }
        }

        // Leave team
        async function leaveTeam(uid, teamCode) {
            if (!confirm("Are you sure you want to leave the team? Your expenses will be deleted.")) return;
            showLoader();
            try {
                await deleteMemberExpenses(uid, teamCode);
                await remove(ref(db, `Team_Details/${teamCode}/Members/${uid}`));
                await update(ref(db, `User_Registration/${uid}`), { TeamCode: "" });
                alert("You left the team and your expenses were deleted.");
                window.location.href = "./user_create_team_page.html";
            } catch (err) {
                console.error(err);
                alert("Error leaving team.");
            } finally { hideLoader(); }
        }

        // Remove member
        async function removeMember(memberUid, teamCode) {
            if (!confirm("Are you sure you want to remove this member? Their expenses will be deleted.")) return;
            showLoader();
            try {
                await deleteMemberExpenses(memberUid, teamCode);
                await remove(ref(db, `Team_Details/${teamCode}/Members/${memberUid}`));
                await update(ref(db, `User_Registration/${memberUid}`), { TeamCode: "" });
                alert("Member removed and their expenses deleted successfully.");
                window.location.reload();
            } catch (err) {
                console.error(err);
                alert("Error removing member.");
            } finally { hideLoader(); }
        }

        // Delete team
        deleteTeamBtn.addEventListener("click", async () => {
            if (!confirm("Are you sure you want to delete the team? All expenses will be deleted, but users remain.")) return;
            showLoader();
            try {
                const teamCode = teamCodeEl.textContent;
                const teamSnap = await get(ref(db, `Team_Details/${teamCode}`));
                if (!teamSnap.exists()) return;
                const team = teamSnap.val();
                // Delete all expenses
                await remove(ref(db, `Team_Details/${teamCode}/Expenses`));
                // Delete members list only
                await remove(ref(db, `Team_Details/${teamCode}/Members`));
                // Remove team metadata
                await remove(ref(db, `Team_Details/${teamCode}/TeamName`));
                await remove(ref(db, `Team_Details/${teamCode}/CreatorUid`));
                alert("Team deleted. All expenses cleared, users remain.");
                window.location.href = "./user_create_team_page.html";
            } catch (err) {
                console.error(err);
                alert("Error deleting team.");
            } finally { hideLoader(); }
        });

        document.getElementById("logoutBtn").addEventListener("click", async (e) => {
            e.preventDefault();
            try { await signOut(auth); window.location.href = "index.html"; }
            catch (err) { console.error(err); }
        });

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "index.html";
            else renderTeamInfo(user.uid);
        });
    </script>

</body>

</html>